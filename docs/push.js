import CONFIG from"../scripts/config";const VAPID_PUBLIC_KEY="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";export async function registerServiceWorker(){if("serviceWorker"in navigator&&"PushManager"in window)try{const e=await navigator.serviceWorker.register("sw.js");console.log("Service Worker registered"),e.installing?await waitUntilActivated(e.installing):e.waiting?await waitUntilActivated(e.waiting):e.active,await subscribeUserToPush(e)}catch(e){console.error("SW registration or subscription failed:",e)}else console.warn("Push messaging is not supported")}function waitUntilActivated(e){return new Promise((t=>{e.addEventListener("statechange",(function(){"activated"===e.state&&t()}))}))}async function subscribeUserToPush(e){const t=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:urlBase64ToUint8Array(VAPID_PUBLIC_KEY)}),i={endpoint:t.endpoint,keys:t.toJSON().keys},r=localStorage.getItem("token"),n=await fetch(`${CONFIG.BASE_URL}/notifications/subscribe`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(i)}),a=await n.json();console.log("Subscribed:",a)}function urlBase64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),i=atob(t);return Uint8Array.from([...i].map((e=>e.charCodeAt(0))))}export{subscribeUserToPush};